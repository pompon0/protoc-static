# use the following action for debugging:
# https://github.com/mxschmitt/action-tmate
name: static-protoc
on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag'
        required: true
      repository:
        desciption: 'protobuf repository'
        required: true
        default: protocolbuffers/protobuf.git
      ref:
        description: 'branch/tag/commit'
        required: true
        default: main
      run_on:
        type: choice
        description: "run-on"
        options:
        - ubuntu-latest
        - macos-latest
        - windows-latest
jobs:
  compile:
    runs-on: ${{ github.event.inputs.run_on }}
    steps:
      - uses: actions/checkout@v3
        with:
          repository: ${{ github.event.inputs.repository }}
          ref: ${{ github.event.inputs.ref }}
      - run: bazel build -c opt //:protoc --features=fully_static_link
      - run: echo "UPLOAD_PATH=$(readlink -f bazel-bin/protoc)" >> $GITHUB_ENV 
      - run: echo "SHA256=$(sha256 ${{ env.UPLOAD_PATH }})" >> $GITHUB_ENV
      - uses: actions/upload-artifact@v3
        with:
          name: protoc
          path: ${{ env.UPLOAD_PATH }}
      - uses: ncipollo/release-action@v1
        with:
          allowUpdates: true
          artifactErrorsFailBuild: true
          draft: true
          tag: ${{ github.event.inputs.release_tag }}_${{ github.event.inputs.run_on }}
          artifacts: ${{ env.UPLOAD_PATH }}
          body: "sha256 = ${{ env.SHA256 }}"


